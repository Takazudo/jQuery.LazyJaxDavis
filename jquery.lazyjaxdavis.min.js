/*! jQuery.LazyJaxDavis - v0.1.3 -  11/4/2012
 * https://github.com/Takazudo/jQuery.LazyJaxDavix
 * Copyright (c) 2012 "Takazudo" Takeshi Takatsudo; Licensed MIT */// Generated by CoffeeScript 1.4.0
(function(){var e=[].slice,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};(function(t,r,i){var s,o,u,a,f;return a={},s=t(i),f=a.wait=function(e){return t.Deferred(function(t){return setTimeout(function(){return t.resolve()},e)})},t.support.pushstate=t.isFunction(r.history.pushState),a.isToId=function(e){return e.charAt(0)==="#"?!0:!1},a.trimGetVals=function(e){return e.replace(/\?.*/,"")},a.tryParseAnotherPageAnchor=function(e){var t,n;return a.isToId(e)?!1:e.indexOf("#")===-1?!1:(t=e.match(/^([^#]+)#(.+)/),n={path:t[1]},t[2]&&(n.hash="#"+t[2]),n)},a.filterStr=function(e,n,r){var i;return r?(i=[],e.replace(n,function(e,t){return i.push(t)}),i):(i=e.match(n),i&&i[1]?t.trim(i[1]):null)},a.logger=r.Davis?(new Davis.logger).logger:null,a.info=u=function(e){if(!a.logger)return;return a.logger.info(e)},a.error=o=function(e){if(!a.logger)return;return a.logger.error(e)},a.fetchPage=function(){var e;return e=null,function(n,r){var i;return i=t.Deferred(function(i){var s;return(e!=null?e.abort:void 0)!=null&&e.abort(),s={url:n},r=t.extend(s,r),e=t.ajax(r),e.then(function(t){return e=null,i.resolve(t)},function(e,t){var n;return n=t==="abort",i.reject(n)})}).promise(),i.abort=function(){return e!=null?typeof e.abort=="function"?e.abort():void 0:void 0},i}}(),a.Event=function(){function t(){this._callbacks={}}return t.prototype.bind=function(e,t){var n,r,i,s,o;n=e.split(" ");for(s=0,o=n.length;s<o;s++)r=n[s],(i=this._callbacks)[r]||(i[r]=[]),this._callbacks[r].push(t);return this},t.prototype.one=function(e,t){return this.bind(e,function(){return this.unbind(e,arguments.callee),t.apply(this,arguments)})},t.prototype.trigger=function(){var t,n,r,i,s,o,u;t=1<=arguments.length?e.call(arguments,0):[],r=t.shift(),i=(u=this._callbacks)!=null?u[r]:void 0;if(!i)return;for(s=0,o=i.length;s<o;s++){n=i[s];if(n.apply(this,t)===!1)break}return this},t.prototype.unbind=function(e,t){var n,r,i,s,o,u;if(!e)return this._callbacks={},this;i=(u=this._callbacks)!=null?u[e]:void 0;if(!i)return this;if(!t)return delete this._callbacks[e],this;for(r=s=0,o=i.length;s<o;r=++s){n=i[r];if(n!==t)continue;i=i.slice(),i.splice(r,1),this._callbacks[e]=i;break}return this},t}(),a.HistoryLogger=function(){function e(){this._items=[],this._items.push(location.pathname.replace(/#.*/,""))}return e.prototype.push=function(e){return this._items.push(e),this},e.prototype.last=function(){var e;return e=this._items.length,e?this._items[e-1]:null},e.prototype.isToSamePageRequst=function(e){var t;return t=this.last(),t?e===t?!0:!1:!1},e.prototype.size=function(){return this._items.length},e}(),a.Page=function(e){function f(e,n,r,i,s,o){var a,l,c,h=this;this.request=e,this.routed=r,this.router=i,this.hash=o,f.__super__.constructor.apply(this,arguments),this.config=t.extend({},this.config,n),this.options=t.extend(!0,{},this.options,s),t.type(this.config.path)==="string"?this.path=this.config.path:this.path=this.request.path,t.each(u,function(e,n){return t.each(h.config,function(e,t){return n!==e?!0:h.bind(n,t)})}),a=((l=this.config)!=null?l.anchorhandler:void 0)||((c=this.options)!=null?c.anchorhandler:void 0),a&&(this._anchorhandler=a),this.bind("pageready",function(){if(!h.hash)return;return h._anchorhandler.call(h,h.hash)})}var u;return n(f,e),u=["fetchstart","fetchsuccess","fetchabort","fetchfail","pageready","anchorhandler"],f.prototype.options={ajxoptions:{dataType:"text",cache:!0},expr:null,updatetitle:!0,title:null},f.prototype.router=null,f.prototype.config=null,f.prototype._text=null,f.prototype._anchorhandler=function(e){var t;return e?(t=s.find(e).offset().top,r.scrollTo(0,t),this):this},f.prototype.fetch=function(){var e,n,r,i,s,o,u=this;e=null,r=this.request.path,n=((i=this.options)!=null?i.ajaxoptions:void 0)||{};if((s=this.config)!=null?s.method:void 0)n.type=this.config.method;if((o=this.request)!=null?o.params:void 0)n.data=t.extend(!0,{},n.data,this.request.params);return this._fetchDefer=t.Deferred(function(t){return e=a.fetchPage(r,n),e.then(function(e){return u._text=e,u.updatetitle(),t.resolve()},function(e){return t.reject({aborted:e})}).always(function(){return u._fetchDefer=null})}),this._fetchDefer.abort=function(){return e.abort()},this._fetchDefer},f.prototype.abort=function(){var e;return(e=this._fetchDefer)!=null&&e.abort(),this},f.prototype.rip=function(e,t){var n,r,i,s;return this._text?e?(n=(i=this.options)!=null?(s=i.expr)!=null?s[e]:void 0:void 0,n?(r=a.filterStr(this._text,n,t),r||o("ripper could not find the text for key: "+e),r):null):this._text:null},f.prototype.ripAll=function(e){return this.rip(e,!0)},f.prototype.updatetitle=function(){var e;return this.options.updatetitle?(e=null,!e&&this._text&&(e=this.rip("title")),e?(i.title=e,this):this):this},f}(a.Event),a.Router=function(r){function i(e){if(!(this instanceof arguments.callee))return new a.Router(e);i.__super__.constructor.apply(this,arguments),this.history=new a.HistoryLogger,e.call(this,this),this.options.davis&&this._setupDavis(),this.firePageready(!this.options.firereadyonstart),this.fireTransPageready()}return n(i,r),i.prototype.options={ajaxoptions:{dataType:"text",cache:!0,type:"GET"},expr:{title:/<title[^>]*>([^<]*)<\/title>/,content:/<!-- LazyJaxDavis start -->([\s\S]*)<!-- LazyJaxDavis end -->/},davis:{linkSelector:"a:not([href^=#]):not(.apply-nolazy)",formSelector:"form:not(.apply-nolazy)",throwErrors:!1,handleRouteNotFound:!0},minwaittime:0,updatetitle:!0,firereadyonstart:!0,ignoregetvals:!1},i.prototype._createPage=function(e,t,n,r){var i,s;return i={expr:this.options.expr,updatetitle:this.options.updatetitle},this.options.anchorhandler&&(i.anchorhandler=this.options.anchorhandler),(t!=null?t.ajaxoptions:void 0)?i.ajaxoptions=t.ajaxoptions:this.options.ajaxoptions&&(i.ajaxoptions=this.options.ajaxoptions),!r&&(e!=null?e.path:void 0)&&(s=a.tryParseAnotherPageAnchor(e.path),r=s.hash||null),new a.Page(e,t,n,this,i,r)},i.prototype._setupDavis=function(){var e,n,r=this;if(!t.support.pushstate)return;return n=this,e=function(e){return e.bind("pageready",function(){return n._findWhosePathMatches("page",e.path),n.trigger("everypageready"),n.fireTransPageready()}),n.history.push(e.path),n.fetch(e)},this.davis=new Davis(function(){var r,i;return r=this,n.pages&&t.each(n.pages,function(i,s){var o;if(t.type(s.path)==="regexp")return;return o=(s.method||"get").toLowerCase(),r[o](s.path,function(t){var r;if(n.history.isToSamePageRequst(t.path))return;return r=n._createPage(t,s,!0),e(r)}),!0}),(i=n.davisInitializer)!=null?i.call(r):void 0}),this.options.davis.handleRouteNotFound&&this.davis.bind("routeNotFound",function(t){var r,i,s,o,u,f;if(a.isToId(t.path)){n.trigger("toid",t.path);return}u=a.tryParseAnotherPageAnchor(t.path),i=u.hash||null,o=u.path||t.path;if(n.history.isToSamePageRequst(o))return;return r=n._findWhosePathMatches("page",o)||null,f=r?!0:!1,s=n._createPage(t,r,f,i),e(s)}),this.davis.configure(function(e){return t.each(r.options.davis,function(t,n){return e[t]=n,!0})}),this._tweakDavis(),this},i.prototype._tweakDavis=function(){var t,n=this;return t=this.davis.logger.warn,u=this.davis.logger.info,this.davis.logger.warn=function(){var r;return r=1<=arguments.length?e.call(arguments,0):[],r[0].indexOf("routeNotFound")!==-1?(r[0]=r[0].replace(/routeNotFound/,"unRouted"),u.apply(n.davis.logger,r)):t.apply(n.davis.logger,r)},this},i.prototype._findWhosePathMatches=function(e,n,r){var i,s,u,f=this;if(e==="page"){if(!this.pages||!this.pages.length)return null;i=this.pages}else if(e==="transRoutes"){if(!this.transRoutes||!this.transRoutes.length)return null;i=this.transRoutes,r=!0}return s=[],u=a.trimGetVals(n),t.each(i,function(e,i){var o;f.options.ignoregetvals||i.ignoregetvals?o=u:o=n;if(t.type(i.path)==="regexp"){if(!i.path.test(o))return!0;s.push(i);if(r)return!0}if(i.path===o){s.push(i);if(r)return!0}return!0}),!r&&s.length>1?(o("2 or more expr was matched about: "+n),t.each(s,function(e,t){return o("dumps detected page configs - path:"+t.path)}),!1):r?s:s[0]||null},i.prototype.fetch=function(e){var n=this;return t.Deferred(function(r){return e.trigger("fetchstart",e),n.trigger("everyfetchstart",e),t.when(e.fetch(),f(n.options.minwaittime)).then(function(){return e.trigger("fetchsuccess",e),n.trigger("everyfetchsuccess",e),r.resolve()},function(t){return t.aborted?(e.trigger("fetchabort",e),n.trigger("everyfetchabort",e)):(e.trigger("fetchfil",e),n.trigger("everyfetchfail",e))})}).promise()},i.prototype.stop=function(){var e;return(e=this.davis)!=null&&e.stop(),this},i.prototype.navigate=function(e,t){var n;return this.davis?(n=new Davis.Request({method:t||"get",fullPath:e,title:""}),Davis.location.assign(n)):location.href=e,this},i.prototype.firePageready=function(e){var t,n;if((n=this.pages)!=null?n.length:void 0)t=this._findWhosePathMatches("page",location.pathname),t&&typeof t.pageready=="function"&&t.pageready();return e?this:(this.trigger("everypageready"),this)},i.prototype.fireTransPageready=function(){var e,n;if((n=this.transRoutes)!=null?n.length:void 0){e=this._findWhosePathMatches("transRoutes",location.pathname);if(!e.length)return this;t.each(e,function(e,t){return typeof t.pageready=="function"?t.pageready():void 0})}return this},i.prototype.route=function(e){return this.pages=e,this},i.prototype.routeTransparents=function(e){return this.transRoutes=e,this},i.prototype.routeDavis=function(e){return this.davisInitializer=e,this},i.prototype.option=function(e){return e?this.options=t.extend(!0,{},this.options,e):this.options},i}(a.Event),t.LazyJaxDavisNs=a,t.LazyJaxDavis=a.Router})(jQuery,this,this.document)}).call(this);